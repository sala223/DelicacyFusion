<?xml version="1.0" encoding="UTF-8"?>
<project name="delicacy-fusion" default="ear">
	<import file="../build/build-env.xml" />
	<property name="modules.dir" value="../modules" />
	<property name="release.directory" value="../release" />
	<if>
		<isset property="ear.name" />
		<else>
			<property name="ear.name" value="delicacy-fusion" />
		</else>
	</if>
	<property name="ear.name" value="${ear.name}" />
	<target name="build-modules">
		<var name="module.name" value="core" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
		<var name="module.name" value="blob-store" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
		<var name="module.name" value="master-data" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
		<var name="module.name" value="order" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
		<var name="module.name" value="http-master-data" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
		<var name="module.name" value="idm" />
		<echo message="Run build for module ${module.name}" />
		<ant antfile="build.xml" target="package" dir="${modules.dir}/${module.name}" inheritall="false" inheritrefs="false" useNativeBasedir="true" />
	</target>
	<target name="ear" depends="build-modules,fast-ear" />
	<target name="fast-ear">
		<delete dir="${release.directory}/${build.version}" quiet="true" />
		<var name="module.name" value="core" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.jar" />
		</copy>
		<var name="module.name" value="blob-store" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.jar" />
		</copy>
		<var name="module.name" value="master-data" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.jar" />
		</copy>
		<var name="module.name" value="order" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.jar" />
		</copy>
		<var name="module.name" value="http-master-data" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.war" />
		</copy>
		<var name="module.name" value="idm" />
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="${modules.dir}/${module.name}/bin" includes="*.jar" />
		</copy>
		<copy flatten="true" todir="${release.directory}/${build.version}/${ear.name}.ear/lib" verbose="true" overwrite="true">
			<fileset dir="./third-lib" includes="**/*.jar" excludes="junit*.jar, hamcrest*.jar, mysql*.jar, sqljdbc*.jar, eclipselink*.jar" />
		</copy>
		<copy todir="${release.directory}/${build.version}/${ear.name}.ear" verbose="true" overwrite="true">
			<fileset dir="./ear" includes="**/*" />
		</copy>
		<replace summary="true" dir="${release.directory}/${build.version}/${ear.name}.ear" propertyFile="${basedir}/env.properties">
			<include name="**/*.xml" />
			<replacefilter token="{build.version}" property="build.version"/>
		</replace>
	</target>
</project>

